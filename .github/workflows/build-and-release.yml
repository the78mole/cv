name: Build PDF and Create Release

on:
  push:
    branches:
      - master  # Triggert bei Push auf master branch
  pull_request:
    branches:
      - master  # Triggert bei Pull Requests auf master branch
  workflow_dispatch:  # Erlaubt manuelles Ausführen

jobs:
  build-and-release-pdf:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v5
      with:
        fetch-depth: 0  # Benötigt für semantic versioning

    - name: Generate semantic version tag
      id: version
      uses: paulhatch/semantic-version@v5.4.0
      with:
        tag_prefix: "v"
        major_pattern: "(MAJOR)"
        minor_pattern: "(MINOR)"
        version_format: "${major}.${minor}.${patch}"
        change_path: "."
        namespace: ""
        bump_each_commit: false
        search_commit_body: false

    - name: Build PDF with LaTeX
      run: |
        # Erstelle PDF mit xu-cheng/texlive-full Image (benannte Container für Copy)
        docker run --name latex-build \
          -v ${{ github.workspace }}:/workspace \
          -w /workspace \
          ghcr.io/xu-cheng/texlive-full:latest \
          sh -c "pdflatex -interaction=nonstopmode -file-line-error Lebenslauf.tex && pdflatex -interaction=nonstopmode -file-line-error Lebenslauf.tex"

        # Kopiere PDF aus Container (für ACT-Kompatibilität)
        docker cp latex-build:/workspace/Lebenslauf.pdf ./Lebenslauf.pdf || echo "Failed to copy PDF from container"
        docker rm latex-build || echo "Failed to remove container"

        # Prüfe ob PDF erfolgreich kopiert wurde
        ls -la *.pdf || echo "No PDF files found after Docker run"

    - name: Get current date
      id: date
      run: echo "date=$(date +%Y-%m-%d)" >> $GITHUB_OUTPUT

    - name: Install uv
      uses: astral-sh/setup-uv@v3
      with:
        version: "latest"

    - name: Extract current CV positions
      id: cv_positions
      run: |
        cd scripts
        echo "positions<<EOF" >> $GITHUB_OUTPUT
        uv run extract-current ../Lebenslauf.tex >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Upload PDF as Artifact
      uses: actions/upload-artifact@v5
      with:
        name: lebenslauf-pdf
        path: "Lebenslauf.pdf"
        retention-days: 30

    - name: Prepare PDF for Release
      run: |
        cp "Lebenslauf.pdf" "Lebenslauf_Daniel_Glaser_${{ steps.version.outputs.version_tag }}_${{ steps.date.outputs.date }}.pdf"

    - name: Create Release and Upload PDF
      if: github.event_name == 'push' && github.ref == 'refs/heads/master' && !env.ACT
      uses: softprops/action-gh-release@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.version.outputs.version_tag }}
        name: Lebenslauf ${{ steps.version.outputs.version_tag }}
        body: |
          Automatisch generierter Lebenslauf vom ${{ steps.date.outputs.date }}

          **Version:** ${{ steps.version.outputs.version_tag }}
          **Previous Version:** ${{ steps.version.outputs.previous_version }}

          ## Aktuelle Positionen
          ${{ steps.cv_positions.outputs.positions }}

          ## Änderungen
          - PDF wurde automatisch aus LaTeX-Quelle generiert
          - Automatisches Semantic Versioning basierend auf Commits
        draft: false
        prerelease: false
        files: |
          ./Lebenslauf_Daniel_Glaser_${{ steps.version.outputs.version_tag }}_${{ steps.date.outputs.date }}.pdf