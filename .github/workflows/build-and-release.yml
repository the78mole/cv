name: Build PDF and Create Release

on:
  push:
    branches:
      - master  # Triggert bei Push auf master branch
  pull_request:
    branches:
      - master  # Triggert bei Pull Requests auf master branch
  workflow_dispatch:  # Erlaubt manuelles AusfÃ¼hren

permissions:
  contents: write  # BenÃ¶tigt fÃ¼r Release-Erstellung
  packages: read   # BenÃ¶tigt fÃ¼r Docker-Images

jobs:
  pre-commit:
    name: Pre-commit Checks
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v5

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: '3.12'

    - name: Install uv
      uses: astral-sh/setup-uv@v3
      with:
        version: "latest"

    - name: Install pre-commit tools
      run: |
        uv tool install pre-commit
        uv tool install detect-secrets

    - name: Run pre-commit
      run: uv tool run pre-commit run --all-files

  build-and-release-pdf:
    name: Build PDF and Create Release
    runs-on: ubuntu-latest
    needs: pre-commit  # Wartet auf erfolgreiche pre-commit checks

    steps:
    - name: Checkout repository
      uses: actions/checkout@v5
      with:
        fetch-depth: 0  # BenÃ¶tigt fÃ¼r semantic versioning

    - name: Generate semantic version tag
      id: version
      uses: paulhatch/semantic-version@v5.4.0
      with:
        tag_prefix: "v"
        major_pattern: "(MAJOR)"
        minor_pattern: "(MINOR)"
        version_format: "${major}.${minor}.${patch}"
        change_path: "."
        namespace: ""
        bump_each_commit: false
        search_commit_body: false

    - name: Build PDF with LaTeX
      run: |
        # Eindeutiger Container-Name mit GitHub Run ID
        CONTAINER_NAME="latex-build-${{ github.run_id }}"

        # Erstelle PDF mit xu-cheng/texlive-full Image (benannte Container fÃ¼r Copy)
        docker run --name "$CONTAINER_NAME" \
          -v "${{ github.workspace }}":/workspace \
          -w /workspace \
          ghcr.io/xu-cheng/texlive-full:latest \
          sh -c "pdflatex -interaction=nonstopmode -file-line-error Lebenslauf.tex && pdflatex -interaction=nonstopmode -file-line-error Lebenslauf.tex"

        # Kopiere PDF aus Container (fÃ¼r ACT-KompatibilitÃ¤t)
        docker cp "$CONTAINER_NAME":/workspace/Lebenslauf.pdf ./Lebenslauf.pdf || echo "Failed to copy PDF from container"
        docker rm "$CONTAINER_NAME" || echo "Failed to remove container"

        # PrÃ¼fe ob PDF erfolgreich kopiert wurde
        ls -la ./*.pdf || echo "No PDF files found after Docker run"

    - name: Get current date
      id: date
      run: echo "date=$(date +%Y-%m-%d)" >> "$GITHUB_OUTPUT"

    - name: Install uv
      uses: astral-sh/setup-uv@v3
      with:
        version: "latest"

    - name: Extract current CV positions
      id: cv_positions
      run: |
        cd scripts
        {
          echo "positions<<EOF"
          uv run extract-current ../Lebenslauf.tex
          echo "EOF"
        } >> "$GITHUB_OUTPUT"

    - name: Upload PDF as Artifact
      uses: actions/upload-artifact@v5
      with:
        name: lebenslauf-pdf
        path: "Lebenslauf.pdf"
        retention-days: 30

    - name: Prepare PDF for Release
      run: |
        cp "Lebenslauf.pdf" "Lebenslauf_Daniel_Glaser_${{ steps.version.outputs.version_tag }}_${{ steps.date.outputs.date }}.pdf"

    - name: Create Release and Upload PDF
      if: github.event_name == 'push' && github.ref == 'refs/heads/master'
      uses: softprops/action-gh-release@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.version.outputs.version_tag }}
        name: Lebenslauf ${{ steps.version.outputs.version_tag }}
        body: |
          Automatisch generierter Lebenslauf vom ${{ steps.date.outputs.date }}

          **Version:** ${{ steps.version.outputs.version_tag }}
          **Previous Version:** ${{ steps.version.outputs.previous_version }}

          ## Aktuelle Positionen
          ${{ steps.cv_positions.outputs.positions }}

          ## Ã„nderungen
          - PDF wurde automatisch aus LaTeX-Quelle generiert
          - Automatisches Semantic Versioning basierend auf Commits

          **ðŸ“‹ [VollstÃ¤ndiges Changelog anzeigen](https://github.com/${{ github.repository }}/compare/${{ steps.version.outputs.previous_version }}...${{ steps.version.outputs.version_tag }})**
        draft: false
        prerelease: false
        files: |
          ./Lebenslauf_Daniel_Glaser_${{ steps.version.outputs.version_tag }}_${{ steps.date.outputs.date }}.pdf
